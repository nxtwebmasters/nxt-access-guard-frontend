<div class="container mx-auto p-4 bg-gray-100 min-h-screen">
  <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto">
    <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">User Profile</h2>

    <div *ngIf="message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
      <span class="block sm:inline">{{ message }}</span>
    </div>
    <div *ngIf="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
      <span class="block sm:inline">{{ errorMessage }}</span>
    </div>

    <ng-container *ngIf="currentUser">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Edit Profile Information</h3>
      <form [formGroup]="profileForm" (ngSubmit)="onUpdateProfile()" class="space-y-4 mb-8">
        <div>
          <label for="profileUsername" class="block text-sm font-medium text-gray-700">Username</label>
          <input type="text" id="profileUsername" formControlName="username"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          <div *ngIf="profileForm.get('username')?.invalid && profileForm.get('username')?.touched" class="text-red-500 text-xs mt-1">
            Username is required.
          </div>
        </div>
        <div>
          <label for="profileEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="profileEmail" formControlName="email"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          <div *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched" class="text-red-500 text-xs mt-1">
            <span *ngIf="profileForm.get('email')?.errors?.['required']">Email is required.</span>
            <span *ngIf="profileForm.get('email')?.errors?.['email']">Enter a valid email address.</span>
          </div>
        </div>

        <div formGroupName="customFields" class="border rounded-md p-3">
            <h4 class="text-md font-semibold text-gray-700 mb-2">Custom Fields</h4>
            <div *ngIf="profileForm.get('customFields')?.value && (profileForm.get('customFields')?.value | keyvalue)?.length === 0" class="text-gray-500 text-sm italic mb-2">No custom fields for this user.</div>
            <div *ngFor="let control of getCustomFieldControls() | keyvalue" class="mb-2 flex items-center">
              <label class="block text-sm font-medium text-gray-700 w-1/3 capitalize">{{ control.key }}</label>
              <input [formControl]="getCustomFieldControl(control.value)" type="text"
                     class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
        </div>

        <button type="submit" [disabled]="profileForm.invalid"
                class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
          Update Profile
        </button>
      </form>

      <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Change Password</h3>
      <form [formGroup]="passwordChangeForm" (ngSubmit)="onChangePassword()" class="space-y-4">
        <div>
          <label for="oldPassword" class="block text-sm font-medium text-gray-700">Current Password</label>
          <input type="password" id="oldPassword" formControlName="oldPassword"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          <div *ngIf="passwordChangeForm.get('oldPassword')?.invalid && passwordChangeForm.get('oldPassword')?.touched" class="text-red-500 text-xs mt-1">
            Current password is required.
          </div>
        </div>
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
          <input type="password" id="newPassword" formControlName="newPassword"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          <div *ngIf="passwordChangeForm.get('newPassword')?.invalid && passwordChangeForm.get('newPassword')?.touched" class="text-red-500 text-xs mt-1">
            <span *ngIf="passwordChangeForm.get('newPassword')?.errors?.['required']">New password is required.</span>
            <span *ngIf="passwordChangeForm.get('newPassword')?.errors?.['minlength']">New password must be at least 6 characters.</span>
          </div>
        </div>
        <div>
          <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
          <input type="password" id="confirmNewPassword" formControlName="confirmNewPassword"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          <div *ngIf="passwordChangeForm.errors?.['mismatch'] && passwordChangeForm.get('confirmNewPassword')?.touched" class="text-red-500 text-xs mt-1">
            Passwords do not match.
          </div>
        </div>
        <button type="submit" [disabled]="passwordChangeForm.invalid"
                class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
          Change Password
        </button>
      </form>
    </ng-container>
  </div>
</div>